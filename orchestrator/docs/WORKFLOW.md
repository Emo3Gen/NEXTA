# NEXA Workflow (Agents v2)

## Двухкликовый цикл (почти автомат)

Клик 1: NEXA_TL_PM выполняет задачу и обновляет HANDOFF
- делает минимальные правки
- обновляет docs/HANDOFF.md
- прогоняет `npm run test:scenarios` (или пишет почему не прогнал)
- пушит в dev

Клик 2: NEXA_REVIEW_QA делает ревью по HANDOFF и даёт одну команду
- если тестов нет — команда: добавить тесты/прогнать
- если есть риск регрессии — команда: минимальный фикс

После фикса:
- TL снова прогоняет тесты
- обновляет HANDOFF.md
- пушит в dev

Только после "✅ зелёные тесты + ✅ ревью ок" владелец делает merge dev → main и пушит main (Render deploy).

---

Этот файл — операционный протокол работы двух агентов в Cursor:
- NEXA_TL_PM (исполнитель)
- NEXA_REVIEW_QA (ревьюер)

Правило: 1 изменение → тест → ревью → фикс → коммит → пуш → деплой.

### Каноническая команда прогона тестов
```bash
cd orchestrator && npm run test:scenarios
```
Endpoint: `/api/message` (server.js). Не менять без согласования.

---

## A) Автогенерация тест-кейсов (внутри Cursor)

### Когда использовать
- добавили новый шаг в диалог
- поменяли приоритеты ввода
- добавили quick_actions
- поменяли нормализацию

### Команда для NEXA_TL_PM
Скопируй в Cursor агенту:

**PROMPT:**


Прочитай docs/NEXA_SPEC.md и docs/NEXA_DIALOG_STATE.md.
Сгенерируй 5–10 новых ручных тестов (Given/When/Then) и добавь их в docs/NEXA_TESTS.md.
Тесты должны покрывать:

глобальные команды перебивают sticky

детские группы только для детей

quick_actions кликом + fallback текстом

отказ телефона

нормализация опечаток
Верни diff только по docs/NEXA_TESTS.md.


---

## B) Саморевью исполнителя перед ответом (встроенный "виртуальный ревьюер")

### Обязательная процедура для NEXA_TL_PM
Перед тем как показать diff пользователю:

**SELF-REVIEW CHECK (внутри ответа):**
1) Какие сценарии мог сломать?
2) Глобальные команды точно перебивают всё?
3) Sticky аренды точно не перехватывает возраст/переключения?
4) Quick_actions: UI не сломан? клик отправляет текст?
5) Формат расписания читаемый и не "одной строкой"?

### Команда (шаблон) для NEXA_TL_PM


Перед финальным ответом выполни SELF-REVIEW CHECK (5 пунктов) и явно напиши:

"✅ Проверено" или "⚠️ Риск"
Если риск — предложи самый маленький фикс.


---

## C) Авто-чеклист перед коммитом (без хуков, просто протокол)

### Перед каждым commit:
1) Прогнать ручные тесты из docs/NEXA_TESTS.md:
   - Детские группы happy path
   - Аренда happy path
   - Глобальные команды перебивают sticky
2) Открыть UI на моб. ширине (DevTools):
   - чипсы quick_actions не ломают верстку
3) Проверить регрессии:
   - нет вопроса "ребёнок/взрослый" внутри детских групп
   - sticky аренды не "залипает" против глобальных команд
4) Обновить docs при изменении логики:
   - SPEC / STATE / TESTS при необходимости

### Формат коммит-сообщения (рекомендуемый)
`ux: quick_actions slots for time step`
`logic: global command priority over sticky rent`

---

## D) Ритуал деплоя Render: prod vs debug режим

### Цель
- локально: можно дебажить и экспериментировать
- пользователи: видят прод-копию
- деплой: commit → push → auto deploy

### Соглашение по режимам
- Debug UI включается только через `?debug=1`
- В проде debug по умолчанию выключен всегда
- Любая "экспериментальная" логика должна быть за флагом:
  `process.env.NEXA_EXPERIMENTS === "1"` (если понадобится)

### Деплой-ритуал
1) Commit в ветку `main`
2) Push
3) Render auto deploy
4) Быстрый smoke test (2 минуты):
   - детские группы до вопроса времени
   - аренда до "принято"
   - глобальная команда "Расписание" внутри аренды

---

## Стандартные промпты для агентов

### Для NEXA_TL_PM (исполнитель)


Задача: [вставь конкретную задачу]

Перед началом:

Прочитай docs/NEXA_SPEC.md

Прочитай docs/NEXA_DIALOG_STATE.md

Требования:

минимальные изменения

без переписывания UI

не ломать "Детские группы" и "Аренда"

глобальные команды всегда выше sticky

Верни:

Что меняешь (1–3 строки)

Diff (только изменённые куски)

SELF-REVIEW CHECK (✅/⚠️)

Как проверить (ссылка на пункты docs/NEXA_TESTS.md)


### Для NEXA_REVIEW_QA (ревью)


Контекст: правки сделаны.

Diff:
[вставить diff]

Как тестировали:
[описание]

Сделай ревью по:

docs/NEXA_SPEC.md

docs/NEXA_DIALOG_STATE.md

docs/NEXA_TESTS.md

Формат:

что ок

риски/регрессии

до 5 замечаний

ОДНА команда на исправление (конкретно: файл/участок/что сделать)

как проверить
